name: Build GodotStarter Base Game

on:
  workflow_dispatch:

jobs:
  build-godotstarter:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout godot-build-template
        uses: actions/checkout@v3
      
      - name: Download Godot Engine
        run: |
          # Try official download first, fallback to GitHub releases
          wget https://downloads.tuxfamily.org/godotengine/4.2.1/Godot_v4.2.1-stable_linux.x86_64.zip || \
          wget https://github.com/godotengine/godot/releases/download/4.2.1-stable/Godot_v4.2.1-stable_linux.x86_64.zip
          
          unzip Godot_v4.2.1-stable_linux.x86_64.zip
          chmod +x Godot_v4.2.1-stable_linux.x86_64
          sudo mv Godot_v4.2.1-stable_linux.x86_64 /usr/local/bin/godot
          
          # Verify installation
          godot --version
      
      - name: Create Godot Project
        run: |
          mkdir -p godotstarter
          cd godotstarter
          
          # Create project.godot file
          cat > project.godot << 'EOF'
          ; Engine configuration file.
          ; It's best edited using the editor UI and not directly,
          ; since the parameters that go here are not all obvious.
          ;
          ; Format:
          ;   [section] ; section goes between []
          ;   param=value ; assign values to parameters
          
          config_version=5
          
          [application]
          
          config/name="StanGame"
          config/description="Generated by Stan AI"
          run/main_scene="res://scenes/Main.tscn"
          config/features=PackedStringArray("4.2", "GL Compatibility")
          config/icon="res://icon.svg"
          
          [display]
          
          window/size/viewport_width=1920
          window/size/viewport_height=1080
          window/size/mode=2
          window/stretch/mode="canvas_items"
          
          [input]
          
          move_left={
          "deadzone": 0.5,
          "events": [Object(InputEventKey,"resource_local_to_scene":false,"resource_name":"","device":-1,"window_id":0,"alt_pressed":false,"shift_pressed":false,"ctrl_pressed":false,"meta_pressed":false,"pressed":false,"keycode":0,"physical_keycode":65,"key_label":0,"unicode":97,"echo":false,"script":null)
          , Object(InputEventKey,"resource_local_to_scene":false,"resource_name":"","device":-1,"window_id":0,"alt_pressed":false,"shift_pressed":false,"ctrl_pressed":false,"meta_pressed":false,"pressed":false,"keycode":0,"physical_keycode":4194319,"key_label":0,"unicode":0,"echo":false,"script":null)
          ]
          }
          move_right={
          "deadzone": 0.5,
          "events": [Object(InputEventKey,"resource_local_to_scene":false,"resource_name":"","device":-1,"window_id":0,"alt_pressed":false,"shift_pressed":false,"ctrl_pressed":false,"meta_pressed":false,"pressed":false,"keycode":0,"physical_keycode":68,"key_label":0,"unicode":100,"echo":false,"script":null)
          , Object(InputEventKey,"resource_local_to_scene":false,"resource_name":"","device":-1,"window_id":0,"alt_pressed":false,"shift_pressed":false,"ctrl_pressed":false,"meta_pressed":false,"pressed":false,"keycode":0,"physical_keycode":4194321,"key_label":0,"unicode":0,"echo":false,"script":null)
          ]
          }
          jump={
          "deadzone": 0.5,
          "events": [Object(InputEventKey,"resource_local_to_scene":false,"resource_name":"","device":-1,"window_id":0,"alt_pressed":false,"shift_pressed":false,"ctrl_pressed":false,"meta_pressed":false,"pressed":false,"keycode":0,"physical_keycode":32,"key_label":0,"unicode":32,"echo":false,"script":null)
          ]
          }
          
          [rendering]
          
          renderer/rendering_method="gl_compatibility"
          renderer/rendering_method.mobile="gl_compatibility"
          EOF
      
      - name: Create Stan Core Scripts
        run: |
          cd godotstarter
          mkdir -p scripts/stan_core
          
          # StanDomainLock.gd
          cat > scripts/stan_core/StanDomainLock.gd << 'EOF'
          extends Node
          
          # Stan's domain protection system
          # Prevents games from running on unauthorized domains
          
          var allowed_domains = ["{{ALLOWED_DOMAINS}}"]
          var project_id = "{{PROJECT_ID}}"
          
          func _ready():
              if OS.has_feature("web"):
                  check_domain()
          
          func check_domain():
              var current_url = JavaScriptBridge.eval("window.location.href")
              var is_valid = false
              
              for domain in allowed_domains:
                  if current_url.find(domain) != -1:
                      is_valid = true
                      break
              
              if not is_valid:
                  show_piracy_screen()
                  get_tree().paused = true
          
          func show_piracy_screen():
              print("Unauthorized domain detected. Game disabled.")
              # Create piracy overlay
              var overlay = ColorRect.new()
              overlay.color = Color.BLACK
              overlay.set_anchors_and_offsets_preset(Control.PRESET_FULL_RECT)
              get_tree().root.add_child(overlay)
              
              var label = Label.new()
              label.text = "This game is protected by Stan.\nPlay at games.stanlink.online"
              label.horizontal_alignment = HORIZONTAL_ALIGNMENT_CENTER
              label.vertical_alignment = VERTICAL_ALIGNMENT_CENTER
              label.set_anchors_and_offsets_preset(Control.PRESET_FULL_RECT)
              overlay.add_child(label)
          EOF
          
          # StanAnalytics.gd
          cat > scripts/stan_core/StanAnalytics.gd << 'EOF'
          extends Node
          
          # Stan's analytics system
          # Tracks game plays and domain usage
          
          var project_id = "{{PROJECT_ID}}"
          var api_url = "https://api.stanlink.online/track"
          
          func _ready():
              if OS.has_feature("web"):
                  phone_home()
          
          func phone_home():
              var current_url = JavaScriptBridge.eval("window.location.href")
              var http_request = HTTPRequest.new()
              add_child(http_request)
              
              var url = api_url + "?id=" + project_id + "&domain=" + current_url
              http_request.request(url)
          EOF
          
          # StanAdManager.gd
          cat > scripts/stan_core/StanAdManager.gd << 'EOF'
          extends Node
          
          # Stan's ad management system
          # Handles Adsterra integration for free-tier games
          
          var is_paid = {{IS_PAID}}
          
          func _ready():
              if not is_paid and OS.has_feature("web"):
                  setup_ads()
          
          func setup_ads():
              # Ads are injected via HTML, this just provides hooks
              pass
          
          func show_interstitial():
              if OS.has_feature("web"):
                  JavaScriptBridge.eval("showAdsterraInterstitial()")
          
          func show_social_bar():
              if OS.has_feature("web"):
                  JavaScriptBridge.eval("showAdsterraSocialBar()")
          EOF
          
          # StanWatermark.gd
          cat > scripts/stan_core/StanWatermark.gd << 'EOF'
          extends Control
          
          # Stan's watermark system
          # Shows "Play on Stan" button for free-tier games
          
          var is_paid = {{IS_PAID}}
          
          func _ready():
              if not is_paid:
                  create_watermark()
          
          func create_watermark():
              # Create "Play on Stan" button in bottom-right corner
              var button = Button.new()
              button.text = "Play on Stan"
              button.size = Vector2(120, 40)
              button.position = Vector2(get_viewport().size.x - 130, get_viewport().size.y - 50)
              button.pressed.connect(_on_stan_button_pressed)
              add_child(button)
          
          func _on_stan_button_pressed():
              if OS.has_feature("web"):
                  JavaScriptBridge.eval("window.open('https://games.stanlink.online', '_blank')")
          EOF
      
      - name: Create Main Scene
        run: |
          cd godotstarter
          mkdir -p scenes
          
          cat > scenes/Main.tscn << 'EOF'
          [gd_scene load_steps=5 format=3 uid="uid://bvn8qrxkqtyc8"]
          
          [ext_resource type="Script" path="res://scripts/stan_core/StanDomainLock.gd" id="1_0"]
          [ext_resource type="Script" path="res://scripts/stan_core/StanAnalytics.gd" id="2_0"]
          [ext_resource type="Script" path="res://scripts/stan_core/StanWatermark.gd" id="3_0"]
          
          [sub_resource type="Environment" id="Environment_1"]
          background_mode = 1
          background_color = Color(0.2, 0.2, 0.3, 1)
          
          [node name="Main" type="Node2D"]
          
          [node name="StanCore" type="Node" parent="."]
          
          [node name="DomainLock" type="Node" parent="StanCore"]
          script = ExtResource("1_0")
          
          [node name="Analytics" type="Node" parent="StanCore"]
          script = ExtResource("2_0")
          
          [node name="UI" type="CanvasLayer" parent="."]
          
          [node name="Watermark" type="Control" parent="UI"]
          layout_mode = 3
          anchors_preset = 15
          anchor_right = 1.0
          anchor_bottom = 1.0
          script = ExtResource("3_0")
          
          [node name="GameContent" type="Node2D" parent="."]
          
          [node name="Label" type="Label" parent="GameContent"]
          anchors_preset = 8
          anchor_left = 0.5
          anchor_top = 0.5
          anchor_right = 0.5
          anchor_bottom = 0.5
          offset_left = -100.0
          offset_top = -50.0
          offset_right = 100.0
          offset_bottom = 50.0
          text = "Stan Game Template
          Ready for AI Generation!"
          horizontal_alignment = 1
          vertical_alignment = 1
          EOF
      
      - name: Create Export Presets
        run: |
          cd godotstarter
          
          cat > export_presets.cfg << 'EOF'
          [preset.0]
          
          name="Web"
          platform="Web"
          runnable=true
          dedicated_server=false
          custom_features=""
          export_filter="all_resources"
          include_filter=""
          exclude_filter=""
          export_path="builds/web/index.html"
          encryption_include_filters=""
          encryption_exclude_filters=""
          encrypt_pck=false
          encrypt_directory=false
          
          [preset.0.options]
          
          custom_template/debug=""
          custom_template/release=""
          variant/extensions_support=false
          vram_texture_compression/for_desktop=true
          vram_texture_compression/for_mobile=false
          html/export_icon=true
          html/custom_html_shell=""
          html/head_include=""
          html/canvas_resize_policy=2
          html/focus_canvas_on_start=true
          html/experimental_virtual_keyboard=false
          progressive_web_app/enabled=false
          progressive_web_app/offline_page=""
          progressive_web_app/display=1
          progressive_web_app/orientation=0
          progressive_web_app/icon_144x144=""
          progressive_web_app/icon_180x180=""
          progressive_web_app/icon_512x512=""
          progressive_web_app/background_color=Color(0, 0, 0, 1)
          EOF
      
      - name: Create Default Icon
        run: |
          cd godotstarter
          
          # Create a simple SVG icon
          cat > icon.svg << 'EOF'
          <svg height="128" width="128" xmlns="http://www.w3.org/2000/svg">
            <rect x="2" y="2" width="124" height="124" rx="14" ry="14" fill="#363d52" stroke="#212532" stroke-width="4"/>
            <g transform="scale(.101) translate(122 122)">
              <g fill="#fff">
                <path d="m464 0c25.49 0 46 20.508 46 46v408c0 25.49-20.51 46-46 46h-408c-25.49 0-46-20.51-46-46v-408c0-25.492 20.508-46 46-46z"/>
                <path d="m436 94v40l-40-20z"/>
                <path d="m436 186v40l-40-20z"/>
                <path d="m436 278v40l-40-20z"/>
                <path d="m436 370v40l-40-20z"/>
              </g>
            </g>
          </svg>
          EOF
      
      - name: Create README.md
        run: |
          cd godotstarter
          
          cat > README.md << 'EOF'
          # ðŸŽ® GodotStarter - Godot Base Game Template
          
          **The Sacred Core** - Protected foundation for all Stan-generated Godot games.
          
          ## ðŸ”’ What is GodotStarter?
          
          GodotStarter is the **protected base template** that every Stan Godot game builds upon. It contains the core systems that ensure games work correctly on Stan's platform while preventing unauthorized distribution.
          
          ## ðŸ“¦ What's Inside?
          
          ### `scripts/stan_core/` (NEVER OVERWRITTEN)
          
          This folder contains Stan's protected systems:
          
          - **StanDomainLock.gd** - Kill switch that prevents games from running on unauthorized domains
          - **StanAnalytics.gd** - Phone-home tracking to monitor where games are played
          - **StanAdManager.gd** - Ad injection points for Adsterra integration
          - **StanWatermark.gd** - "Play on Stan" branding overlay (free tier only)
          
          ### `scenes/Main.tscn`
          
          The main scene with Stan's core systems pre-configured.
          
          ### `project.godot`
          
          Godot project configuration with:
          - Web export settings
          - Input mappings
          - Display settings
          - Rendering configuration
          
          ### `export_presets.cfg`
          
          Pre-configured export settings for HTML5/WebGL builds.
          
          ## ðŸš€ How Stan Uses This
          
          1. **Clone GodotStarter** â†’ Creates new project from this template
          2. **Import Templates** â†’ Adds game-specific templates to `scenes/templates/`
          3. **Generate Code** â†’ Stan AI writes game code to `scripts/`
          4. **Inject Config** â†’ GitHub Actions replaces placeholders:
             - `{{PROJECT_ID}}` â†’ Actual project ID
             - `{{IS_PAID}}` â†’ true/false based on user tier
             - `{{ALLOWED_DOMAINS}}` â†’ Whitelisted domains
          5. **Build WebGL** â†’ Godot exports the complete game
          6. **Deploy to R2** â†’ Uploaded to `games.stanlink.online/{project_id}`
          
          ## ðŸ” Security Features
          
          ### Domain Lock
          Games only run on whitelisted domains. If someone downloads your game files and hosts them elsewhere, the domain lock kills the game immediately.
          
          ### Origin Guard
          Cloudflare Worker protects R2 assets - only serves files to whitelisted domains.
          
          ### Analytics Tracking
          Every game play is tracked with domain information, so you know where your game is being played.
          
          ### WASM Protection
          Godot's WebGL export produces optimized WASM that's difficult to reverse engineer.
          
          ## ðŸŽ¯ Result
          
          **Game files can be downloaded, but they're USELESS outside your domain!** ðŸ”’âœ¨
          
          ## ðŸ“ Placeholders
          
          These placeholders are replaced during build:
          
          - `{{PROJECT_ID}}` - Unique project identifier
          - `{{IS_PAID}}` - Boolean flag for paid/free tier
          - `{{ALLOWED_DOMAINS}}` - Comma-separated list of authorized domains
          
          ## ðŸš« What NOT to Modify
          
          **NEVER modify files in `scripts/stan_core/`** - These are Stan's protected systems and will break domain locking, analytics, and ad integration.
          
          ## ðŸ“š Learn More
          
          - [Stan Documentation](https://docs.stanlink.online)
          - [Stan Dashboard](https://dashboard.stanlink.online)
          - [Stan IDE](https://ide.stan.stanlink.online)
          
          ---
          
          **Built with â¤ï¸ by StanLink Inc.**
          EOF
      
      - name: Clone godotstarter repo
        run: |
          git config --global user.name "Stan Bot"
          git config --global user.email "bot@stanlink.online"
          git clone https://${{ secrets.ACCESS_TOKEN }}@github.com/StaNLink-Inc/godotstarter.git godotstarter-repo
      
      - name: Copy files to repo
        run: |
          rm -rf godotstarter-repo/*
          cp -r godotstarter/* godotstarter-repo/
      
      - name: Commit and push
        run: |
          cd godotstarter-repo
          git add .
          git commit -m "ðŸŽ® Update GodotStarter base game template" || echo "No changes to commit"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}
      
      - name: Success notification
        run: |
          echo "âœ… GodotStarter successfully built and pushed!"
          echo "ðŸ“¦ Repository: https://github.com/StaNLink-Inc/godotstarter"