name: Build Godot HTML5

on:
  workflow_dispatch:
    inputs:
      project_id:
        description: 'Project ID'
        required: true
        type: string
      game_name:
        description: 'Game Name'
        required: true
        type: string
      build_type:
        description: 'Build Type'
        required: false
        default: 'Release'
        type: choice
        options:
          - Release
          - Debug
      compression:
        description: 'Enable Compression'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      compression_level:
        description: 'Compression Level (0-9)'
        required: false
        default: '6'
        type: string
      enable_encryption:
        description: 'Enable PCK Encryption'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      debug_mode:
        description: 'Enable Debug Mode'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Godot
      uses: chickensoft-games/setup-godot@v1
      with:
        version: 4.3.0
        use-dotnet: false

    - name: Install Godot Export Templates
      run: |
        echo "üì• Downloading Godot 4.3 export templates..."
        TEMPLATES_URL="https://github.com/godotengine/godot/releases/download/4.3-stable/Godot_v4.3-stable_export_templates.tpz"
        curl -L "$TEMPLATES_URL" -o godot_templates.tpz
        
        # Create the templates directory
        mkdir -p ~/.local/share/godot/export_templates/4.3.stable
        
        # Unzip templates
        unzip godot_templates.tpz -d templates_temp
        
        # Move templates to the correct location
        mv templates_temp/templates/* ~/.local/share/godot/export_templates/4.3.stable/
        
        # Clean up
        rm -rf templates_temp godot_templates.tpz
        echo "‚úÖ Export templates installed"
        
    - name: Download project files from R2
      env:
        R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
        AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_KEY }}
        AWS_DEFAULT_REGION: auto
        R2_SOURCE_BUCKET: stan-projects
      run: |
        echo "üì• Downloading Godot project from R2..."
        
        # Check if secrets are missing
        if [ -z "$AWS_ACCESS_KEY_ID" ]; then echo "‚ùå AWS_ACCESS_KEY_ID is missing!"; fi
        if [ -z "$AWS_SECRET_ACCESS_KEY" ]; then echo "‚ùå AWS_SECRET_ACCESS_KEY is missing!"; fi
        if [ -z "$R2_ENDPOINT" ]; then echo "‚ùå R2_ENDPOINT is missing!"; fi
        
        # Install or update AWS CLI v2
        if command -v aws &> /dev/null;
        then
          echo "AWS CLI already installed"
        else
          echo "Installing AWS CLI..."
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          sudo apt-get update && sudo apt-get install -y unzip
          unzip awscliv2.zip
          sudo ./aws/install
        fi
        
        # Check if project exists in R2
        echo "Checking if project exists in R2: s3://$R2_SOURCE_BUCKET/${{ github.event.inputs.project_id }}/"
        if aws s3 ls s3://$R2_SOURCE_BUCKET/${{ github.event.inputs.project_id }}/ --endpoint-url $R2_ENDPOINT;
        then
          echo "Project found in R2, downloading..."
          # Download project files to godot-project directory
          mkdir -p godot-project
          aws s3 sync s3://$R2_SOURCE_BUCKET/${{ github.event.inputs.project_id }}/ ./godot-project/ --endpoint-url $R2_ENDPOINT
          
          echo "‚úÖ Project downloaded"
          ls -la godot-project/
        else
          echo "‚ùå CRITICAL: Project NOT found in R2!"
          echo "Expected path: s3://$R2_SOURCE_BUCKET/${{ github.event.inputs.project_id }}/"
          exit 1
        fi
        
    - name: Verify Godot project
      run: |
        if [ ! -f "godot-project/project.godot" ]; then
          echo "Error: project.godot not found in downloaded files"
          ls -R godot-project/
          exit 1
        fi
        echo "Godot project verified"
        
    - name: Configure export settings
      run: |
        cd godot-project
        
        ENCRYPT_PCK=${{ github.event.inputs.enable_encryption }}
        DEBUG_MODE=${{ github.event.inputs.debug_mode }}
        
        # Create or Overwrite export_presets.cfg
        cat > export_presets.cfg << EOF
        [preset.0]
        
        name="HTML5"
        platform="Web"
        runnable=true
        dedicated_server=false
        custom_features=""
        export_filter="all_resources"
        include_filter=""
        exclude_filter=""
        export_path="build/index.html"
        encryption_include_filters=""
        encryption_exclude_filters=""
        encrypt_pck=${ENCRYPT_PCK}
        encrypt_directory=false
        
        [preset.0.options]
        
        custom_template/debug=""
        custom_template/release=""
        variant/extensions_support=false
        vram_texture_compression/for_desktop=true
        vram_texture_compression/for_mobile=false
        html/export_icon=true
        html/custom_html_shell=""
        html/head_include=""
        html/canvas_resize_policy=2
        html/focus_canvas_on_start=true
        html/experimental_virtual_keyboard=false
        progressive_web_app/enabled=false
        progressive_web_app/offline_page=""
        progressive_web_app/display=1
        progressive_web_app/orientation=0
        progressive_web_app/icon_144x144=""
        progressive_web_app/icon_180x180=""
        progressive_web_app/icon_512x512=""
        progressive_web_app/background_color=Color(0, 0, 0, 1)
        EOF
        
        echo "‚úÖ Export presets configured (Encryption: $ENCRYPT_PCK)"
        
    - name: Export Godot project
      run: |
        cd godot-project
        mkdir -p build
        
        # Export for HTML5
        if [ "${{ github.event.inputs.build_type }}" = "Debug" ]; then
          godot --headless --export-debug "HTML5" build/index.html
        else
          godot --headless --export-release "HTML5" build/index.html
        fi
        
    - name: Apply compression
      if: github.event.inputs.compression == 'true'
      run: |
        cd godot-project/build
        
        # Compress files based on compression level
        LEVEL=${{ github.event.inputs.compression_level }}
        
        # Compress .wasm and .pck files
        for file in *.wasm *.pck;
        do
          if [ -f "$file" ]; then
            gzip -${LEVEL} -c "$file" > "$file.gz"
            echo "Compressed $file"
          fi
        done
        
    - name: Upload build to R2
      env:
        R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
        AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_KEY }}
        AWS_DEFAULT_REGION: auto
        R2_GAMES_BUCKET: stan-games
      run: |
        cd godot-project
        
        # Upload to R2 (public-read is not supported by default in R2 S3 API)
        aws s3 sync build/ s3://stan-games/${{ github.event.inputs.project_id }}/ --endpoint-url $R2_ENDPOINT
        
        # Set the play URL
        PLAY_URL="https://games.stanlink.online/${{ github.event.inputs.project_id }}/index.html"
        echo "Game will be available at: $PLAY_URL"
        
    - name: Notify build completion
      if: success()
      env:
        STAN_API_KEY: ${{ secrets.STAN_API_KEY }}
        STAN_BACKEND_URL: ${{ secrets.STAN_BACKEND_URL }}
      run: |
        PLAY_URL="https://games.stanlink.online/${{ github.event.inputs.project_id }}/index.html"
        
        # Notify backend
        curl -X POST "$STAN_BACKEND_URL/api/build/complete" \
          -H "Authorization: Bearer $STAN_API_KEY" \
          -H "Content-Type: application/json" \
          -d "{
            \"project_id\": \"${{ github.event.inputs.project_id }}\",
            \"status\": \"success\",
            \"deploy_url\": \"$PLAY_URL\",
            \"engine\": \"godot\",
            \"game_name\": \"${{ github.event.inputs.game_name }}\" 
          }"
        
        # Send success email
        curl -X POST "https://mailer.stanlink.online/stanlink.online/mailer1/stan-build-succesful" \
          -H "Content-Type: application/json" \
          -d "{
            \"to\": \"${{ secrets.NOTIFICATION_EMAIL }}\",
            \"sender\": \"stan\",
            \"variables\": {
              \"subject\": \"üéÆ ${{ github.event.inputs.game_name }} - Godot Build Complete!\",
              \"game_name\": \"${{ github.event.inputs.game_name }}\",
              \"engine\": \"Godot\",
              \"play_url\": \"$PLAY_URL\"
            }
          }"
    
    - name: Notify build failure
      if: failure()
      env:
        STAN_API_KEY: ${{ secrets.STAN_API_KEY }}
        STAN_BACKEND_URL: ${{ secrets.STAN_BACKEND_URL }}
      run: |
        # Notify backend of failure
        curl -X POST "$STAN_BACKEND_URL/api/build/complete" \
          -H "Authorization: Bearer $STAN_API_KEY" \
          -H "Content-Type: application/json" \
          -d "{
            \"project_id\": \"${{ github.event.inputs.project_id }}\",
            \"status\": \"failed\",
            \"engine\": \"godot\",
            \"game_name\": \"${{ github.event.inputs.game_name }}"
          }"
        
        # Send failure email
        curl -X POST "https://mailer.stanlink.online/stanlink.online/mailer1/stan-build-failed" \
          -H "Content-Type: application/json" \
          -d "{
            \"to\": \"${{ secrets.NOTIFICATION_EMAIL }}\",
            \"sender\": \"stan\",
            \"variables\": {
              \"subject\": \"‚ùå ${{ github.event.inputs.game_name }} - Godot Build Failed\",
              \"game_name\": \"${{ github.event.inputs.game_name }}\",
              \"engine\": \"Godot\",
              \"error_message\": \"Build failed during GitHub Actions workflow\"
            }
          }"