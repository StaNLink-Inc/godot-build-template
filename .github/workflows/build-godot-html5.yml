name: Build Godot HTML5

on:
  workflow_dispatch:
    inputs:
      project_id:
        description: 'Project ID'
        required: true
        type: string
      game_name:
        description: 'Game Name'
        required: true
        type: string
      build_type:
        description: 'Build Type'
        required: false
        default: 'Release'
        type: choice
        options:
          - Release
          - Debug
      compression:
        description: 'Enable Compression'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      compression_level:
        description: 'Compression Level (0-9)'
        required: false
        default: '6'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Godot
      uses: chickensoft-games/setup-godot@v1
      with:
        version: 4.3.0
        use-dotnet: false
        
    - name: Download project files from R2
      env:
        R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
        R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
        R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
        R2_SOURCE_BUCKET: stan-projects
      run: |
        echo "üì• Downloading Godot project from R2..."
        
        # Install or update AWS CLI v2
        if command -v aws &> /dev/null; then
          echo "AWS CLI already installed, updating..."
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          sudo apt-get update && sudo apt-get install -y unzip
          unzip awscliv2.zip
          sudo ./aws/install --update
        else
          echo "Installing AWS CLI..."
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          sudo apt-get update && sudo apt-get install -y unzip
          unzip awscliv2.zip
          sudo ./aws/install
        fi
        
        # Configure AWS CLI for R2
        aws configure set aws_access_key_id $R2_ACCESS_KEY
        aws configure set aws_secret_access_key $R2_SECRET_KEY
        aws configure set region auto
        
        # Check if project exists in R2
        echo "Checking if project exists in R2..."
        if aws s3 ls s3://$R2_SOURCE_BUCKET/${{ github.event.inputs.project_id }}/ --endpoint-url $R2_ENDPOINT; then
          echo "Project found in R2, downloading..."
          # Download project files to godot-project directory
          mkdir -p godot-project
          aws s3 sync s3://$R2_SOURCE_BUCKET/${{ github.event.inputs.project_id }}/ ./godot-project/ --endpoint-url $R2_ENDPOINT
          
          echo "‚úÖ Project downloaded"
          ls -la godot-project/
        else
          echo "‚ö†Ô∏è Project not found in R2, creating minimal project..."
          mkdir -p godot-project
          
          # Create minimal project.godot file
          cat > godot-project/project.godot << 'EOF'
        ; Engine configuration file.
        ; It's best edited using the editor UI and not directly,
        ; since the parameters that go here are not all obvious.
        ;
        ; Format:
        ;   [section] ; section goes between []
        ;   param=value ; assign values to parameters
        
        config_version=5
        
        [application]
        
        config/name="${{ github.event.inputs.game_name }}"
        run/main_scene="res://Main.tscn"
        config/features=PackedStringArray("4.3", "GL Compatibility")
        config/icon="res://icon.svg"
        
        [rendering]
        
        renderer/rendering_method="gl_compatibility"
        renderer/rendering_method.mobile="gl_compatibility"
        EOF
          
          # Create minimal main scene
          cat > godot-project/Main.tscn << 'EOF'
        [gd_scene load_steps=2 format=3 uid="uid://bvxvgxqahyeah"]
        
        [ext_resource type="Script" path="res://Main.gd" id="1_0q8yh"]
        
        [node name="Main" type="Node2D"]
        script = ExtResource("1_0q8yh")
        
        [node name="Label" type="Label" parent="."]
        anchors_preset = 8
        anchor_left = 0.5
        anchor_top = 0.5
        anchor_right = 0.5
        anchor_bottom = 0.5
        offset_left = -100.0
        offset_top = -50.0
        offset_right = 100.0
        offset_bottom = 50.0
        grow_horizontal = 2
        grow_vertical = 2
        text = "${{ github.event.inputs.game_name }}"
        horizontal_alignment = 1
        vertical_alignment = 1
        EOF
          
          # Create minimal main script
          cat > godot-project/Main.gd << 'EOF'
        extends Node2D
        
        # Called when the node enters the scene tree for the first time.
        func _ready():
        	print("Game started: ${{ github.event.inputs.game_name }}")
        
        # Called every frame. 'delta' is the elapsed time since the previous frame.
        func _process(delta):
        	pass
        EOF
          
          # Create default icon
          cat > godot-project/icon.svg << 'EOF'
        <svg height="128" width="128" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="2" width="124" height="124" rx="14" fill="#363d52" stroke="#212532" stroke-width="4"/><g transform="scale(.101) translate(122 122)"><g fill="#fff"><path d="M105 673v33q407 354 814 0v-33z"/><path d="m105 673 152 14q12 1 15 14l4 67 132 10 8-61q2-11 15-15h162q13 4 15 15l8 61 132-10 4-67q3-13 15-14l152-14V427q30-39 56-81-35-59-83-108-43 20-82 47-40-37-88-64 7-51 8-102-59-28-123-42-26 43-46 89-49-7-98 0-20-46-46-89-64 14-123 42 1 51 8 102-48 27-88 64-39-27-82-47-48 49-83 108 26 42 56 81zm0 33v39c0 276 813 276 813 0v-39l-134 12-5 69q-2 10-14 13l-162 11q-12 0-16-11l-10-65H447l-10 65q-4 11-16 11l-162-11q-12-3-14-13l-5-69z"/><path d="M483 600c3 34 55 34 58 0v-86c-3-34-55-34-58 0z"/><path d="M481 699c-17 16-2 53 22 37 2-2 2-5 2-9V618c0-4 0-7-2-9-24-16-39 21-22 37z"/><path d="M519 699c17 16 32-21 22-37-2 2-2 5-2 9v109c0 4 0 7 2 9 10 16 5-21-22-37z"/></g></svg>
        EOF
          
          echo "‚úÖ Minimal project created"
          ls -la godot-project/
        fi
        
    - name: Verify Godot project
      run: |
        if [ ! -f "godot-project/project.godot" ]; then
          echo "Error: project.godot not found"
          exit 1
        fi
        echo "Godot project verified"
        
    - name: Configure export settings
      run: |
        cd godot-project
        
        # Create export_presets.cfg if it doesn't exist
        if [ ! -f "export_presets.cfg" ]; then
          cat > export_presets.cfg << 'EOF'
        [preset.0]
        
        name="HTML5"
        platform="Web"
        runnable=true
        dedicated_server=false
        custom_features=""
        export_filter="all_resources"
        include_filter=""
        exclude_filter=""
        export_path="build/index.html"
        encryption_include_filters=""
        encryption_exclude_filters=""
        encrypt_pck=false
        encrypt_directory=false
        
        [preset.0.options]
        
        custom_template/debug=""
        custom_template/release=""
        variant/extensions_support=false
        vram_texture_compression/for_desktop=true
        vram_texture_compression/for_mobile=false
        html/export_icon=true
        html/custom_html_shell=""
        html/head_include=""
        html/canvas_resize_policy=2
        html/focus_canvas_on_start=true
        html/experimental_virtual_keyboard=false
        progressive_web_app/enabled=false
        progressive_web_app/offline_page=""
        progressive_web_app/display=1
        progressive_web_app/orientation=0
        progressive_web_app/icon_144x144=""
        progressive_web_app/icon_180x180=""
        progressive_web_app/icon_512x512=""
        progressive_web_app/background_color=Color(0, 0, 0, 1)
        EOF
        fi
        
    - name: Export Godot project
      run: |
        cd godot-project
        mkdir -p build
        
        # Export for HTML5
        if [ "${{ github.event.inputs.build_type }}" = "Debug" ]; then
          godot --headless --export-debug "HTML5" build/index.html
        else
          godot --headless --export-release "HTML5" build/index.html
        fi
        
    - name: Apply compression
      if: github.event.inputs.compression == 'true'
      run: |
        cd godot-project/build
        
        # Compress files based on compression level
        LEVEL=${{ github.event.inputs.compression_level }}
        
        # Compress .wasm and .pck files
        for file in *.wasm *.pck; do
          if [ -f "$file" ]; then
            gzip -$LEVEL -c "$file" > "$file.gz"
            echo "Compressed $file"
          fi
        done
        
    - name: Upload build to R2
      env:
        R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
        R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
        R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}
        R2_GAMES_BUCKET: stan-games
      run: |
        cd godot-project
        
        # Upload to R2 with public access
        aws s3 sync build/ s3://stan-games/${{ github.event.inputs.project_id }}/ --endpoint-url $R2_ENDPOINT --acl public-read
        
        # Set the play URL
        PLAY_URL="https://games.stanlink.online/${{ github.event.inputs.project_id }}/index.html"
        echo "Game will be available at: $PLAY_URL"
        
    - name: Notify build completion
      if: success()
      env:
        STAN_API_KEY: ${{ secrets.STAN_API_KEY }}
        STAN_BACKEND_URL: ${{ secrets.STAN_BACKEND_URL }}
      run: |
        PLAY_URL="https://games.stanlink.online/${{ github.event.inputs.project_id }}/index.html"
        
        # Notify backend
        curl -X POST "$STAN_BACKEND_URL/api/build/complete" \
          -H "Authorization: Bearer $STAN_API_KEY" \
          -H "Content-Type: application/json" \
          -d "{
            \"project_id\": \"${{ github.event.inputs.project_id }}\",
            \"status\": \"success\",
            \"deploy_url\": \"$PLAY_URL\",
            \"engine\": \"godot\",
            \"game_name\": \"${{ github.event.inputs.game_name }}\"
          }"
        
        # Send success email
        curl -X POST "https://mailer.stanlink.online/stanlink.online/mailer1/stan-build-succesful" \
          -H "Content-Type: application/json" \
          -d "{
            \"to\": \"${{ secrets.NOTIFICATION_EMAIL }}\",
            \"sender\": \"stan\",
            \"variables\": {
              \"subject\": \"üéÆ ${{ github.event.inputs.game_name }} - Godot Build Complete!\",
              \"game_name\": \"${{ github.event.inputs.game_name }}\",
              \"engine\": \"Godot\",
              \"play_url\": \"$PLAY_URL\"
            }
          }"
    
    - name: Notify build failure
      if: failure()
      env:
        STAN_API_KEY: ${{ secrets.STAN_API_KEY }}
        STAN_BACKEND_URL: ${{ secrets.STAN_BACKEND_URL }}
      run: |
        # Notify backend of failure
        curl -X POST "$STAN_BACKEND_URL/api/build/complete" \
          -H "Authorization: Bearer $STAN_API_KEY" \
          -H "Content-Type: application/json" \
          -d "{
            \"project_id\": \"${{ github.event.inputs.project_id }}\",
            \"status\": \"failed\",
            \"engine\": \"godot\",
            \"game_name\": \"${{ github.event.inputs.game_name }}\"
          }"
        
        # Send failure email
        curl -X POST "https://mailer.stanlink.online/stanlink.online/mailer1/stan-build-failed" \
          -H "Content-Type: application/json" \
          -d "{
            \"to\": \"${{ secrets.NOTIFICATION_EMAIL }}\",
            \"sender\": \"stan\",
            \"variables\": {
              \"subject\": \"‚ùå ${{ github.event.inputs.game_name }} - Godot Build Failed\",
              \"game_name\": \"${{ github.event.inputs.game_name }}\",
              \"engine\": \"Godot\",
              \"error_message\": \"Build failed during GitHub Actions workflow\"
            }
          }"