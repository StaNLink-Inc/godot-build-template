name: Build Godot HTML5

on:
  workflow_dispatch:
    inputs:
      project_id:
        description: 'Project ID'
        required: true
        type: string
      slug:
        description: 'Game Slug'
        required: true
        type: string
      game_name:
        description: 'Game Name'
        required: true
        type: string
      build_type:
        description: 'Build Type'
        required: false
        default: 'Release'
        type: choice
        options:
          - Release
          - Debug
      compression:
        description: 'Enable Compression'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      compression_level:
        description: 'Compression Level (0-9)'
        required: false
        default: '6'
        type: string
      enable_encryption:
        description: 'Enable PCK Encryption'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      debug_mode:
        description: 'Enable Debug Mode'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Godot
      uses: chickensoft-games/setup-godot@v1
      with:
        version: 4.3.0
        use-dotnet: false

    - name: Install Godot Export Templates
      run: |
        echo "üì• Downloading Godot 4.3 export templates..."
        TEMPLATES_URL="https://github.com/godotengine/godot/releases/download/4.3-stable/Godot_v4.3-stable_export_templates.tpz"
        curl -L "$TEMPLATES_URL" -o godot_templates.tpz
        mkdir -p ~/.local/share/godot/export_templates/4.3.stable
        unzip godot_templates.tpz -d templates_temp
        mv templates_temp/templates/* ~/.local/share/godot/export_templates/4.3.stable/
        rm -rf templates_temp godot_templates.tpz
        echo "‚úÖ Export templates installed"
        
    - name: Download project files from R2
      env:
        R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
        AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_KEY }}
        AWS_DEFAULT_REGION: auto
        R2_SOURCE_BUCKET: stan-projects
      run: |
        echo "üì• Downloading Godot project from R2..."
        if [ -z "$AWS_ACCESS_KEY_ID" ]; then echo "‚ùå AWS_ACCESS_KEY_ID is missing!"; exit 1; fi
        
        # Check if project exists
        if aws s3 ls s3://$R2_SOURCE_BUCKET/${{ github.event.inputs.project_id }}/ --endpoint-url $R2_ENDPOINT; then
          mkdir -p godot-project
          aws s3 sync s3://$R2_SOURCE_BUCKET/${{ github.event.inputs.project_id }}/ ./godot-project/ --endpoint-url $R2_ENDPOINT
          echo "‚úÖ Project downloaded"
        else
          echo "‚ùå CRITICAL: Project NOT found in R2!"
          exit 1
        fi
        
    - name: Configure export settings
      run: |
        cd godot-project
        ENCRYPT_PCK=${{ github.event.inputs.enable_encryption }}
        cat > export_presets.cfg << EOF
        [preset.0]
        name="HTML5"
        platform="Web"
        runnable=true
        export_path="build/index.html"
        encrypt_pck=${ENCRYPT_PCK}
        [preset.0.options]
        html/canvas_resize_policy=2
        html/focus_canvas_on_start=true
        EOF
        
    - name: Export Godot project
      id: export
      run: |
        cd godot-project
        mkdir -p build
        echo "üèóÔ∏è Starting export..."
        # üìù LOGGING: Redirect output to build.log so we can capture errors
        if [ "${{ github.event.inputs.build_type }}" = "Debug" ]; then
          godot --headless --export-debug "HTML5" build/index.html > build.log 2>&1
        else
          godot --headless --export-release "HTML5" build/index.html > build.log 2>&1
        fi
        
    - name: Apply compression
      if: success() && github.event.inputs.compression == 'true'
      run: |
        cd godot-project/build
        for file in *.wasm *.pck; do
          if [ -f "$file" ]; then gzip -${{ github.event.inputs.compression_level }} -c "$file" > "$file.gz"; fi
        done
        
    - name: Upload build to R2
      if: success()
      env:
        R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
        AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_KEY }}
        AWS_DEFAULT_REGION: auto
      run: |
        cd godot-project
        aws s3 sync build/ s3://stan-games/${{ github.event.inputs.slug }}/ --endpoint-url $R2_ENDPOINT
        
    - name: Upload Logs to R2 on failure
      if: failure()
      env:
        R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
        AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_KEY }}
        AWS_DEFAULT_REGION: auto
      run: |
        if [ -f "godot-project/build.log" ]; then
          aws s3 cp godot-project/build.log s3://stan-projects/${{ github.event.inputs.project_id }}/logs/build.log --endpoint-url $R2_ENDPOINT
          echo "üìù Error logs uploaded to R2"
        fi

    - name: Notify Build Result
      if: always()
      env:
        STAN_API_KEY: ${{ secrets.STAN_API_KEY }}
        STAN_BACKEND_URL: ${{ secrets.STAN_BACKEND_URL }}
      run: |
        STATUS="success"
        if [ "${{ job.status }}" != "success" ]; then STATUS="failed"; fi
        
        ERROR_SUMMARY=""
        if [ "$STATUS" = "failed" ] && [ -f "godot-project/build.log" ]; then
          # Capture last 15 lines of log for the email/agent
          ERROR_SUMMARY=$(tail -n 15 godot-project/build.log | base64 -w 0)
        fi
        
        PLAY_URL="https://games.stanlink.online/${{ github.event.inputs.slug }}"
        
        curl -X POST "$STAN_BACKEND_URL/api/build/complete" \
          -H "Authorization: Bearer $STAN_API_KEY" \
          -H "Content-Type: application/json" \
          -d "{
            \"project_id\": \"${{ github.event.inputs.project_id }}\",
            \"status\": \"$STATUS\",
            \"deploy_url\": \"$PLAY_URL\",
            \"engine\": \"godot\",
            \"game_name\": \"${{ github.event.inputs.game_name }}\",
            \"log_context\": \"$ERROR_SUMMARY\"
          }"
